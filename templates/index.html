<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>股票模擬預測 & 技術分析</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.4.3/dist/css/bootstrap.min.css"/>
  <!-- 下面假設你原本有的 autocomplete 樣式或 scripts 都留著 -->
</head>
<body class="p-4">
  <!-- 保留你原本的自選欄位 HTML，完全不動 -->
  <!-- 例如： -->
  <div id="ticker-widget">
    <!-- 你現有的 autocomplete input -->
  </div>

  <!-- 進度條 -->
  <div class="progress my-3">
    <div id="bar" class="progress-bar" role="progressbar" style="width:0%">
      資料下載中，請稍候
    </div>
  </div>

  <!-- 結果區 -->
  <div id="results" style="display:none">
    <img id="trend" class="img-fluid mb-3" alt="模擬走勢圖"/>
    <img id="hist" class="img-fluid mb-3" alt="直方圖"/>
    <h4>模擬數據</h4><ul id="stats"></ul>
    <h4>技術指標</h4><ul id="inds"></ul>
    <h4>研究員觀點</h4><p id="viewpoint"></p>
    <h4>操作建議</h4><p id="advice" class="fw-bold"></p>
  </div>

  <script>
    const bar = document.getElementById("bar"),
          results = document.getElementById("results"),
          trend = document.getElementById("trend"),
          hist = document.getElementById("hist"),
          stats = document.getElementById("stats"),
          inds  = document.getElementById("inds"),
          vp    = document.getElementById("viewpoint"),
          adv   = document.getElementById("advice"),
          form  = document.querySelector("form");  // 你的原 form

    form.onsubmit = e=>{
      e.preventDefault();
      results.style.display="none";
      bar.style.width="0%"; bar.innerText="資料下載中，請稍候";
      const params = new URLSearchParams(new FormData(form)),
            es = new EventSource("/api/stock_stream?"+params);
      es.onmessage = ev=>{
        const d = ev.data.trim();
        if (d.startsWith("{")) {
          // 完成
          bar.style.width="100%";
          setTimeout(()=> bar.parentElement.style.display="none",300);
          const o = JSON.parse(d);
          trend.src = o.trend_img;
          hist.src  = o.hist_img;
          stats.innerHTML = `
            <li>平均：${o.stats.avg} 元</li>
            <li>現價：${o.stats.curr} 元</li>
            <li>範圍：${o.stats.min}-${o.stats.max} 元</li>
            <li>波動：${o.stats.vol} 元 (${o.stats.vol_pct})</li>`;
          inds.innerHTML = `
            <li>MA20：${o.inds.MA20}</li>
            <li>MA50：${o.inds.MA50}</li>
            <li>RSI14：${o.inds.RSI14}</li>
            <li>MACD：${o.inds.MACD}</li>`;
          vp.innerText = `產業：${o.industry}；簡介：${o.summary}`;
          adv.innerText = o.advice;
          results.style.display="block";
          es.close();
        } else {
          // 進度
          bar.style.width = d+"%";
          bar.innerText = "資料下載中，請稍候";
        }
      };
    };
  </script>
</body>
</html>
