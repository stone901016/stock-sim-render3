<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8">
  <title>Stock 模擬預測</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="p-4">

  <h1 class="mb-4">Stock 模擬預測</h1>

  <form id="simForm" class="row g-3 mb-4">
    <div class="col-md-4">
      <label for="symbol" class="form-label">股票代號</label>
      <input list="symbols" id="symbol" class="form-control" required>
      <datalist id="symbols">
        <option value="AAPL"><option value="MSFT"><option value="GOOGL">
      </datalist>
    </div>
    <div class="col-md-4">
      <label for="horizon" class="form-label">預測時間</label>
      <select id="horizon" class="form-select">
        <option>1D</option><option>1W</option><option>1M</option>
        <option>3M</option><option>6M</option><option>1Y</option>
      </select>
    </div>
    <div class="col-md-4">
      <label for="simulations" class="form-label">模擬次數</label>
      <input type="number" id="simulations" class="form-control" value="10000" min="100" max="100000">
    </div>
    <div class="col-12">
      <button type="submit" class="btn btn-primary">開始模擬</button>
    </div>
  </form>

  <div class="progress mb-4">
    <div id="progBar" class="progress-bar" role="progressbar" style="width: 0%;">資料下載中，請稍後…</div>
  </div>

  <div id="resultSection" style="display:none;">
    <h2>模擬結果</h2>
    <div id="plotContainer" class="mb-4"></div>
    <canvas id="histChart" height="100"></canvas>
    <div id="researchCommentary" class="mt-4"></div>
  </div>

  <script>
    let histChart;

    document.getElementById('simForm').addEventListener('submit', e => {
      e.preventDefault();
      document.getElementById('resultSection').style.display = 'none';
      document.getElementById('plotContainer').innerHTML = '';
      const bar = document.getElementById('progBar');
      bar.style.width = '0%';
      bar.innerText = '資料下載中，請稍後…';

      const sym = document.getElementById('symbol').value;
      const hor = document.getElementById('horizon').value;
      const sim = document.getElementById('simulations').value;

      const es = new EventSource(`/api/stock_stream?symbol=${sym}&horizon=${hor}&simulations=${sim}`);

      es.onmessage = e => {
        const raw = e.data.trim();
        if (/^\d+$/.test(raw)) {
          const pct = parseInt(raw);
          bar.style.width = `${pct}%`;
          bar.innerText = `${pct}%`;
        } else {
          bar.style.width = '100%';
          bar.innerText = '100% (完成)';
          es.close();
          document.getElementById('resultSection').style.display = 'block';
          const d = JSON.parse(raw);

          // 走勢圖
          const img = document.createElement('img');
          img.src = d.plot_img;
          img.className = 'img-fluid mb-4';
          document.getElementById('plotContainer').appendChild(img);

          // 次數分佈圖
          const finals = d.hist_data;
          const bins = 50;
          const min = Math.min(...finals), max = Math.max(...finals), step = (max - min) / bins;
          const counts = Array(bins).fill(0);
          finals.forEach(v => counts[Math.min(Math.floor((v - min) / step), bins-1)]++);
          const labels = counts.map((_, i) => `${(min + i*step).toFixed(0)}~${(min + (i+1)*step).toFixed(0)}`);
          if (histChart) histChart.destroy();
          const ctx = document.getElementById('histChart').getContext('2d');
          histChart = new Chart(ctx, {
            type: 'bar',
            data: { labels, datasets: [{ label: '次數', data: counts }] },
            options: {
              scales: {
                x: { title: { display: true, text: '價格區間' } },
                y: { title: { display: true, text: '次數' } }
              },
              plugins: { legend: { display: false } }
            }
          });

          // 研究員觀點
          document.getElementById('researchCommentary').innerHTML = d.commentary_html;
        }
      };
    });
  </script>

</body>
</html>
