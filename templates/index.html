<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>股票模擬預測 & 技術分析</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { padding: 2rem; }
    #plot-img { max-width: 100%; margin-top: 1rem; }
  </style>
</head>
<body>
  <h1 class="text-center mb-4">股票模擬預測 & 技術分析</h1>

  <form id="form" class="row g-3 align-items-end">
    <div class="col-md-4">
      <label class="form-label">股票代號</label>
      <input type="text" class="form-control" id="symbol" value="2330.TW">
    </div>
    <div class="col-md-4">
      <label class="form-label">預測時間</label>
      <select class="form-select" id="horizon">
        <option value="1Y">1 年</option>
        <option value="6M">6 個月</option>
        <option value="3M">3 個月</option>
        <option value="1M">1 個月</option>
        <option value="1W">1 週</option>
        <option value="1D">1 日</option>
      </select>
    </div>
    <div class="col-md-4">
      <label class="form-label">模擬次數</label>
      <select class="form-select" id="sims">
        <option value="10000">10,000 次</option>
        <option value="20000">20,000 次</option>
        <option value="50000">50,000 次</option>
        <option value="100000" selected>100,000 次</option>
      </select>
    </div>
    <div class="col-12">
      <button type="button" id="btn" class="btn btn-primary">開始分析</button>
    </div>
  </form>

  <div class="progress my-3" style="height:1.5rem;">
    <div id="bar" class="progress-bar" role="progressbar" style="width:0%">0%</div>
  </div>

  <!-- 1）標題 & 研究員觀點 -->
  <h2 id="title" class="mt-4 text-center"></h2>
  <div id="research" class="mb-4 fst-italic"></div>

  <!-- 2）走勢圖 -->
  <img id="plot-img" src="" alt="走勢圖">

  <!-- 3）文字建議 -->
  <div id="commentary" class="mt-4"></div>

<script>
document.getElementById('btn').addEventListener('click', () => {
  // 先清空
  document.getElementById('bar').style.width = '0%';
  document.getElementById('bar').innerText = '0%';
  document.getElementById('title').innerText = '';
  document.getElementById('research').innerText = '';
  document.getElementById('plot-img').src = '';
  document.getElementById('commentary').innerHTML = '';

  const sym  = document.getElementById('symbol').value.trim();
  const hor  = document.getElementById('horizon').value;
  const sims = document.getElementById('sims').value;

  const es = new EventSource(`/api/stock_stream?symbol=${sym}&horizon=${hor}&simulations=${sims}`);

  es.onmessage = e => {
    // 純數字：更新進度
    if (/^\d+$/.test(e.data)) {
      const n = parseInt(e.data);
      document.getElementById('bar').style.width = n + '%';
      document.getElementById('bar').innerText = n + '%';
      return;
    }

    let msg;
    try {
      msg = JSON.parse(e.data);
    } catch {
      return;
    }

    // meta 區塊：更新標題 & 研究員觀點
    if (msg.meta) {
      const m = msg.meta;
      document.getElementById('title').innerText = 
        `${m.symbol} 預測未來股價 ${m.horizon} (${m.sims} 次模擬)`;
      document.getElementById('research').innerText = '研究員觀點：根據歷史資料與技術指標進行蒙地卡羅模擬，請稍候…';
      return;
    }

    // 最後一次 result：把圖、建議一次渲染
    if (msg.result) {
      const R = msg.result;
      // 圖
      document.getElementById('plot-img').src = 'data:image/png;base64,' + R.plot_img;
      // 建議 HTML
      document.getElementById('commentary').innerHTML = R.commentary_html;
      // 完成後關閉連線
      es.close();
    }
  };

  es.onerror = () => {
    es.close();
  };
});
</script>
</body>
</html>
