<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>股票模擬預測 & 技術分析</title>
  <link rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.4.3/dist/css/bootstrap.min.css"/>
</head>
<body class="container py-4">

  <!-- 原本的自選欄位區塊，請直接貼回你本地那整段 autocomplete HTML -->
  <form id="filter-form" class="row g-3 align-items-center">
    <div class="col-auto">
      <label for="symbol" class="col-form-label">股票代號</label>
    </div>
    <div class="col-auto">
      <input list="symbol-list" id="symbol" name="symbol" class="form-control"
             placeholder="請輸入代號" autocomplete="off"/>
      <datalist id="symbol-list">
        <!-- 你原本的 <option> 都會跑在這裡 -->
      </datalist>
    </div>
    <div class="col-auto">
      <label for="horizon" class="col-form-label">預測時間</label>
    </div>
    <div class="col-auto">
      <select id="horizon" name="horizon" class="form-select">
        <option value="1Y">1 年</option>
        <option value="6M">6 個月</option>
        <option value="3M">3 個月</option>
        <option value="1M">1 個月</option>
        <option value="1W">1 週</option>
        <option value="1D">1 日</option>
      </select>
    </div>
    <div class="col-auto">
      <label for="simulations" class="col-form-label">模擬次數</label>
    </div>
    <div class="col-auto">
      <select id="simulations" name="simulations" class="form-select">
        <option value="10000">10,000 次</option>
        <option value="20000">20,000 次</option>
        <option value="50000">50,000 次</option>
        <option value="100000" selected>100,000 次</option>
        <option value="200000">200,000 次</option>
      </select>
    </div>
    <div class="col-auto">
      <button id="run-btn" type="submit" class="btn btn-primary">開始分析</button>
    </div>
  </form>

  <!-- 進度條：只這一行，不影響上方欄位 -->
  <div class="progress my-3">
    <div id="bar" class="progress-bar" role="progressbar" style="width:0%">
      資料下載中，請稍候
    </div>
  </div>

  <!-- 結果：隱藏到進度 100% 才顯示 -->
  <div id="results" style="display:none;">
    <img id="trend" class="img-fluid mb-3" alt="模擬走勢圖"/>
    <img id="hist" class="img-fluid mb-3" alt="最終價格分佈"/>
    <h4>模擬數據</h4>
    <ul id="stats"></ul>
    <h4>技術指標</h4>
    <ul id="inds"></ul>
    <h4>研究員觀點</h4>
    <p id="viewpoint"></p>
    <h4>操作建議</h4>
    <p id="advice" class="fw-bold"></p>
  </div>

  <script>
    const form = document.getElementById("filter-form"),
          bar  = document.getElementById("bar"),
          res  = document.getElementById("results"),
          trend = document.getElementById("trend"),
          hist = document.getElementById("hist"),
          stats= document.getElementById("stats"),
          inds = document.getElementById("inds"),
          vp   = document.getElementById("viewpoint"),
          adv  = document.getElementById("advice");

    form.addEventListener("submit", e=>{
      e.preventDefault();
      res.style.display="none";
      bar.style.width="0%";
      bar.innerText="資料下載中，請稍候";
      bar.parentElement.style.display="block";

      const params=new URLSearchParams(new FormData(form)),
            src=new EventSource("/api/stock_stream?"+params);

      src.onmessage = evt => {
        let d = evt.data.trim();
        if (d.startsWith("{")) {
          // 完成
          bar.style.width="100%";
          setTimeout(()=>bar.parentElement.style.display="none",300);
          const o=JSON.parse(d);
          trend.src = o.trend_img;
          hist.src  = o.hist_img;
          stats.innerHTML=`
            <li>平均：${o.stats.avg} 元</li>
            <li>現價：${o.stats.curr} 元</li>
            <li>範圍：${o.stats.min}-${o.stats.max} 元</li>
            <li>波動：${o.stats.vol} 元 (${o.stats.vol_pct})</li>`;
          inds.innerHTML=`
            <li>MA20：${o.inds.MA20}</li>
            <li>MA50：${o.inds.MA50}</li>
            <li>RSI14：${o.inds.RSI14}</li>
            <li>MACD：${o.inds.MACD}</li>`;
          vp.innerText = `產業：${o.industry}；簡介：${o.summary}`;
          adv.innerText = o.advice;
          res.style.display="block";
          src.close();
        } else {
          // 進度
          bar.style.width = d+"%";
        }
      };
    });
  </script>
</body>
</html>
