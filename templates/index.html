<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>股票模擬預測 & 技術分析</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.4.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
</head>
<body class="p-4">
  <h2 class="mb-4 text-center">股票模擬預測 & 技術分析</h2>

  <form id="fm" class="row g-3 align-items-center mb-3">
    <div class="col-auto">
      <label class="form-label">股票代號</label>
      <input type="text" class="form-control" name="symbol" value="2330.TW" />
    </div>
    <div class="col-auto">
      <label class="form-label">預測時間</label>
      <select class="form-select" name="horizon">
        <option>1D</option><option>1W</option><option>1M</option>
        <option selected>1Y</option><option>3M</option><option>6M</option>
      </select>
    </div>
    <div class="col-auto">
      <label class="form-label">模擬次數</label>
      <select class="form-select" name="simulations">
        <option>1000</option><option selected>100000</option>
        <option>200000</option><option>500000</option>
      </select>
    </div>
    <div class="col-auto">
      <button type="submit" class="btn btn-primary">開始分析</button>
    </div>
  </form>

  <div class="progress mb-4">
    <div id="bar" class="progress-bar" role="progressbar" style="width:0%">
      資料下載中，請稍候
    </div>
  </div>

  <div id="results" style="display:none">
    <div class="mb-4">
      <img id="trend" class="img-fluid border" alt="走勢圖"/>
    </div>
    <div class="mb-4">
      <img id="hist" class="img-fluid border" alt="次數分佈圖"/>
    </div>
    <h4>模擬數據</h4>
    <ul id="stats"></ul>
    <h4>技術指標</h4>
    <ul id="inds"></ul>
    <h4>研究員觀點</h4>
    <p id="viewpoint"></p>
    <h4>操作建議</h4>
    <p id="advice" class="fw-bold"></p>
  </div>

  <script>
    const fm = document.getElementById("fm");
    const bar = document.getElementById("bar");
    const resDiv = document.getElementById("results");
    const trend = document.getElementById("trend");
    const hist = document.getElementById("hist");
    const stats = document.getElementById("stats");
    const inds = document.getElementById("inds");
    const vp = document.getElementById("viewpoint");
    const adv = document.getElementById("advice");

    fm.onsubmit = e => {
      e.preventDefault();
      resDiv.style.display = "none";
      bar.style.width = "0%";
      bar.innerText = "資料下載中，請稍候";
      const p = new URLSearchParams(new FormData(fm));
      const es = new EventSource("/api/stock_stream?"+p);
      es.onmessage = ev => {
        const d = ev.data.trim();
        if (d.startsWith("{")) {
          // 完成
          bar.style.width = "100%";
          setTimeout(()=> bar.parentElement.style.display="none",500);
          const o = JSON.parse(d);
          trend.src = o.trend_img;
          hist.src  = o.hist_img;
          stats.innerHTML = `
            <li>平均價格：${o.stats.avg} 元</li>
            <li>當前價格：${o.stats.curr} 元</li>
            <li>範圍：${o.stats.min}-${o.stats.max} 元</li>
            <li>波動度：${o.stats.vol} 元 (${o.stats.vol_pct})</li>`;
          inds.innerHTML = `
            <li>20日MA：${o.indicators.MA20}</li>
            <li>50日MA：${o.indicators.MA50}</li>
            <li>RSI(14)：${o.indicators.RSI14}</li>
            <li>MACD 柱狀圖：${o.indicators.MACD}</li>`;
          vp.innerText = `產業類別：${o.industry}；公司簡介：${o.summary}`;
          adv.innerText = o.advice;
          resDiv.style.display = "block";
          es.close();
        } else {
          // 只更新長度
          bar.style.width = d+"%";
          bar.innerText = "資料下載中，請稍候";
        }
      };
    };
  </script>
</body>
</html>
